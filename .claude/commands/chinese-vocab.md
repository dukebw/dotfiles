# 中文詞彙 Anki 卡片製作器

從 Zoom 聊天記錄或詞彙列表建立中文詞彙填空卡片 (Cloze cards)。

## 參數 (Arguments)

* `$ARGUMENTS` - 詞彙檔案路徑，可選擇加上 `--dry-run`

解析參數：
- 若包含 `--dry-run`：設定 DRY_RUN=true，在終端機預覽卡片
- 否則：DRY_RUN=false，將卡片加入 Anki

## 工作流程 (Workflow)

### 1. 提取詞彙（不可排除）

讀取詞彙檔案並提取中文詞彙。尋找：

* 聊天格式：`從 Name 對 所有人: 詞語`
* 獨立的中文單詞/片語

**關鍵：提取所有詞彙。不允許排除任何內容 (NO EXCLUSIONS ALLOWED)。**

* 專有名詞 (地名、人名、品牌) → **包含** (例如：大阪, 時代廣場, 環球影城)
* 片語/慣用語 → **包含** (例如：做中學, 先睡著)
* 複合詞條 (A/B 或 A、B) → 視為**分開**的單詞，每個都要做卡片
* 俚語/口語 → **包含**

建立一個編號表格。這是你的**約束性契約 (binding contract)** —— 每一行都**必須**產生至少一張卡片。

| # | 詞語 | 備註 |
| --- | --- | --- |
| 1 | ... |  |
| 2 | ... |  |

**主要詞彙計數 = N** (請明確指出此數字)

### 2. 規劃相關詞彙 & 建立目標列表

對於每個主要單詞，找出 1-3 個相關詞 (同義詞、反義詞、相關詞、搭配詞)。

**關鍵：在發送子代理之前，先建立完整的目標列表。**

步驟 1 中的每個主要單詞**必須**出現在此表中。然後添加相關詞，直到總數 ≥ 2×N。

指派來源輪替以確保多樣性：

| # | 目標詞 | 類型 | 語域 | 來源 | 輪替 |
|---|--------|------|------|------|------|
| 1 | 主題 | main | 書面 | news | cna |
| 2 | 議題 | related | 書面 | news | udn |
| 3 | 分析 | main | 書面 | news | ltn |
| 4 | 解析 | related | 書面 | news | pts |
| 5 | 阿伯 | main | 口語 | forum | gamer |
| 6 | 大叔 | related | 口語 | forum | ptt-snippet |
| 7 | 實作 | main | 技術 | tech | techbang |
| 8 | 大阪 | main | 專有名詞 | news/wiki | cna |
| ... |  |  |  |  |  |

**語域 (Register) 分類：**

* **書面/正式** → cna, udn, ltn, pts (輪替)
* **口語/日常** → gamer, ptt-snippet, dcard-snippet (輪替)
* **技術/專業** → techbang, ithome-snippet (輪替)
* **專有名詞** → 新聞網站、維基百科、旅遊網站

**硬性要求：在繼續之前，目標列表計數 ≥ 2×N。**

請聲明："目標列表：M 個單詞 (M ≥ 2×N = 2×__ = __) ✓"

### 3. 發送子代理 (10-WAY PARALLELISM)

使用 Task 工具搭配 `subagent_type: "vocab-card-searcher"` 來搜尋例句。

**每批次發送 10 個並行子代理。**

對於每個目標詞，使用以下提示格式建立任務：
```
Search and create a vocabulary card:
- target: 主題
- type: main
- register: 書面
- source_pool: news
- source_rotation: cna

Return JSON with: target, type, register, success, front, back, source_name, source_domain
```

**批次執行：**
```
批次 1：目標 1-10（透過單一訊息中的 10 個 Task 工具呼叫，並行發送全部 10 個）
批次 2：目標 11-20
批次 3：目標 21-30
...
```

等待每個批次完成後再開始下一批。

### 4. 收集結果 & 驗證完整性

收集所有子代理結果。追蹤表格：

| # | 目標詞 | 成功 | 來源 | 網域 |
|---|--------|------|------|------|
| 1 | 主題 | ✓ | 中央社 | cna |
| 2 | 議題 | ✓ | 聯合報 | udn |
| 3 | 阿伯 | ✓ | 巴哈姆特 | gamer |
| ... | | | | |

**驗證：**
- [ ] 所有目標都回傳 success=true
- [ ] 成功卡片總數 ≥ 2×N
- [ ] 無單一網域 >40% 的卡片
- [ ] 口語詞彙來自論壇，非新聞

**若任何目標失敗：** 使用不同來源輪替重新發送該特定目標。

**強制停止點：直到所有目標都有成功的卡片後才能繼續。**

### 5. 建立卡片 (Single Writer)

從子代理收集所有成功的卡片資料。

**最終驗證：**
- 收集的卡片數：___
- 目標列表大小：___
- 主要詞彙計數 (N)：___
- 所需最小值 (2×N)：___

**所有條件必須為真：**
- [ ] 收集的卡片數 = 目標列表大小
- [ ] 收集的卡片數 ≥ 2×N
- [ ] 每張卡片都有 2-3 個句子
- [ ] 步驟 1 的每個主要詞彙至少有 1 張卡片

---

## 若 DRY_RUN=true：預覽卡片

在終端機顯示每張卡片：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Card 1/36: 主題 (main) [書面 → 中央社]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

文字:
Google表示，Android 10特色主要圍繞在創新、安全與隱私、
數位健康等3大{{c1::主題|}}。以下為Android 10的10大特色。

註記:
來源：中央社
注音：ㄓㄨˇ ㄊㄧˊ
釋義：文章或談話的中心內容

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Card 2/36: 議題 (related) [書面 → 聯合報]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
...
```

顯示所有卡片後，顯示摘要：

```
═══════════════════════════════════════════════════════
DRY RUN 摘要
═══════════════════════════════════════════════════════
總卡片數：36
主要詞彙：18
比例：2.0× ✓

來源分布：
  cna.com.tw:     8 張卡片 (22%) ✓
  udn.com:        6 張卡片 (17%) ✓
  ltn.com.tw:     5 張卡片 (14%) ✓
  pts.org.tw:     4 張卡片 (11%) ✓
  gamer.com.tw:   5 張卡片 (14%) ✓
  techbang.com:   3 張卡片 (8%) ✓
  snippets:       5 張卡片 (14%) ✓

所有品質閘門通過 ✓
執行時不加 --dry-run 即可將卡片加入 Anki。
═══════════════════════════════════════════════════════
```

**若為 dry run，在此停止。不要加入 Anki。**

---

## 若 DRY_RUN=false：加入 Anki

需求：Anki 正在執行，並安裝了 AnkiConnect 附加元件 (代碼：2055492159)

```python
#!/usr/bin/env python3
import requests

CARDS = [
    # 從子代理結果填充
    # (front_with_cloze, back_notes),
]

def add_note(front, back):
    r = requests.post('http://localhost:8765', json={
        "action": "addNote",
        "version": 6,
        "params": {
            "note": {
                "deckName": "hanzi",
                "modelName": "克漏題",
                "fields": {"文字": front, "註記": back},
                "options": {"allowDuplicate": False},
                "tags": ["claude-vocab"]
            }
        }
    })
    result = r.json()
    if result.get("error"):
        raise Exception(result["error"])
    return result["result"]

for front, back in CARDS:
    nid = add_note(front, back)
    print(f"Added note {nid}")

print(f"\n✓ Added {len(CARDS)} cards to hanzi deck")
```

---

## 品質閘門 (強制性 MANDATORY)

**完整性 (不可協商)：**

* 輸入文件中的每個單詞至少得到 1 張卡片 (不可排除)
* 專有名詞、地名、片語 → 全部都要做卡片
* 總卡片數 ≥ 2× 主要詞彙計數

**卡片品質：**

* 全中文：卡片上沒有英文
* 每張卡片 2-3 個句子 (不是 1 句)
* 具備出處的真實來源

**來源多樣性：**

* 無單一網域 >40% 的卡片
* 每個語域類別使用 ≥2 個不同來源
* 口語詞彙來自論壇/摘要，而非新聞網站

## 應避免的失敗模式
- ❌ 「排除專有名詞」- 不允許
- ❌ 「跳過片語」- 不允許
- ❌ 「從 18 個詞彙只建立了 21 張卡片」- 未達 2× 要求
- ❌ 搜尋了某個詞但沒有為它建立卡片
- ❌ 在所有目標都有例句之前就進入卡片建立階段
- ❌ 未使用完整的 10-way 並行發送子代理
